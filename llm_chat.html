<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>LLM Chat Debug</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f9f9f9; }
    #chat { white-space: pre-wrap; background: #fff; padding: 10px; border: 1px solid #ccc; max-height: 400px; overflow-y: auto; margin-bottom: 10px; }
    .user { color: blue; margin-bottom: 5px; }
    .assistant { color: green; margin-bottom: 10px; }
    textarea { width: 100%; height: 60px; }
  </style>
</head>
<body>

<h2>üí¨ Chat —Å LLM (debug-–≤–µ—Ä—Å–∏—è)</h2>

<div id="chat"></div>

<textarea id="input" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å..."></textarea><br>
<button onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

<script>
  let messages = [
    {
      role: "system",
      content: "–¢—ã –¥–µ—Ä–∑–∫–∞—è, –¥—Ä—É–∂–µ–ª—é–±–Ω–∞—è —Ä—É—Å—Å–∫–∞—è –¥–µ–≤—É—à–∫–∞. –û—Ç–≤–µ—á–∞–π –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ, –ø–æ-—Ä—É—Å—Å–∫–∏, —Å —é–º–æ—Ä–æ–º –∏ —Å–º–∞–π–ª–∏–∫–∞–º–∏."
    }
  ];

  // üîß –í—Å—Ç–∞–≤—å —Å—é–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å —Ç–≤–æ–µ–≥–æ CloudPub –∏–ª–∏ http://localhost:1234
  const apiUrl = "https://impishly-staid-euglena.cloudpub.ru/v1/chat/completions";

  async function send() {
    const input = document.getElementById("input");
    const chat = document.getElementById("chat");
    const prompt = input.value.trim();
    if (!prompt) return;

    messages.push({ role: "user", content: prompt });
    renderChat();

    input.value = "‚åõ –ñ–¥—ë–º –æ—Ç–≤–µ—Ç...";
    input.disabled = true;

    const payload = {
      model: "gemma-3n-e4b-it-text",
      messages: messages,
      temperature: 0.8,
      max_tokens: 512
    };

    console.log("üì§ API URL:", apiUrl);
    console.log("üì§ JSON payload:", JSON.stringify(payload));

    try {
      const res = await fetch(apiUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const raw = await res.text();
      console.log("üì• RAW –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", raw);

      if (!res.ok) {
        alert("‚ùå –û—à–∏–±–∫–∞ HTTP: " + res.status + "\n" + raw);
        input.disabled = false;
        input.value = "";
        return;
      }

      let data;
      try {
        data = JSON.parse(raw);
      } catch (e) {
        alert("üí• –û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ JSON-–æ—Ç–≤–µ—Ç–∞:\n" + raw);
        input.disabled = false;
        input.value = "";
        return;
      }

      const reply = data.choices?.[0]?.message?.content ?? "‚ö†Ô∏è –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –º–æ–¥–µ–ª–∏";
      messages.push({ role: "assistant", content: reply });

    } catch (error) {
      alert("üí• –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:\n" + error);
    }

    input.disabled = false;
    input.value = "";
    renderChat();
  }

  function renderChat() {
    const chat = document.getElementById("chat");
    chat.innerHTML = "";
    for (let msg of messages) {
      if (msg.role === "user")
        chat.innerHTML += `<div class="user">üë§ <b>–¢—ã:</b> ${msg.content}</div>`;
      if (msg.role === "assistant")
        chat.innerHTML += `<div class="assistant">ü§ñ <b>–ò–ò:</b> ${msg.content}</div>`;
    }
    chat.scrollTop = chat.scrollHeight;
  }
</script>

</body>
</html>
